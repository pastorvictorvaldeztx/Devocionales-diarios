<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devocional Diario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 420px;
            margin: auto;
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
        }
        textarea {
            resize: vertical;
            min-height: 150px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Este código asegura que el script se ejecute solo cuando toda la página se haya cargado.
        document.addEventListener('DOMContentLoaded', () => {
            // Global variables provided by the environment
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // UI elements
            const homeScreen = document.getElementById('home-screen');
            const menuScreen = document.getElementById('menu-screen');
            const devotionalScreen = document.getElementById('devotional-screen');
            const adminScreen = document.getElementById('admin-screen');
            const adminLoginScreen = document.getElementById('admin-login-screen');
            const startButton = document.getElementById('startButton');
            const adminButton = document.getElementById('adminButton');
            const todayButton = document.getElementById('todayButton');
            const pastDevotionalsButton = document.getElementById('pastDevotionalsButton');
            const backButton = document.getElementById('backButton');
            const backFromAdminButton = document.getElementById('backFromAdmin');
            const backFromDevotionalButton = document.getElementById('backFromDevotional');
            const devotionalTitleEl = document.getElementById('devotionalTitle');
            const devotionalContentEl = document.getElementById('devotionalContent');
            const pastDevotionalsList = document.getElementById('past-devotionals-list');
            const addDevotionalForm = document.getElementById('addDevotionalForm');
            const adminLoginForm = document.getElementById('adminLoginForm');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageButton = document.getElementById('closeMessageButton');
            const pastDevotionalsScreen = document.getElementById('past-devotionals-screen');
            const backFromPastButton = document.getElementById('backFromPast');
            const backFromAdminLoginButton = document.getElementById('backFromAdminLogin');

            let user;
            let pastDevotionalsData = {};

            // Function to show a temporary message box
            const showMessage = (text, type = 'info') => {
                messageText.textContent = text;
                messageBox.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            };

            closeMessageButton.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });

            // Firebase Authentication
            const setupAuth = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error al autenticar:", error);
                    showMessage("Error de autenticación. Por favor, recarga la página.");
                }
            };

            onAuthStateChanged(auth, (authUser) => {
                if (authUser) {
                    user = authUser;
                    console.log("Usuario autenticado:", user.uid);
                    // Listen for devotionals once authenticated
                    listenForDevotionals();
                } else {
                    console.log("Usuario no autenticado, iniciando sesión anónimamente...");
                    setupAuth();
                }
            });

            // Firestore Logic
            const listenForDevotionals = () => {
                if (!user) {
                    console.error("No hay usuario autenticado para escuchar los devocionales.");
                    return;
                }
                // Use the public collection for shared data
                const devocionalesCol = collection(db, `artifacts/${appId}/public/data/devocionales`);
                // onSnapshot listens for real-time updates
                onSnapshot(devocionalesCol, (snapshot) => {
                    pastDevotionalsData = {};
                    snapshot.forEach(doc => {
                        pastDevotionalsData[doc.id] = doc.data();
                    });
                    console.log("Devocionales cargados:", Object.keys(pastDevotionalsData).length);
                }, (error) => {
                    console.error("Error al obtener los devocionales:", error);
                    showMessage("Error al cargar los devocionales. Por favor, recarga la página.");
                });
            };
            
            // --- Lógica del modo de administración con contraseña ---
            // Contraseña para el modo de administración (¡cambia esto por una más segura!)
            const ADMIN_PASSWORD = "Salmos23";

            adminButton.addEventListener('click', () => {
                menuScreen.classList.add('hidden');
                adminLoginScreen.classList.remove('hidden');
            });

            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = e.target.password.value;
                if (password === ADMIN_PASSWORD) {
                    adminLoginScreen.classList.add('hidden');
                    adminScreen.classList.remove('hidden');
                } else {
                    showMessage("Contraseña incorrecta. Intenta de nuevo.", 'error');
                    e.target.reset();
                }
            });

            // Este es el formulario para agregar devocionales
            addDevotionalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = e.target.title.value;
                const content = e.target.content.value;
                if (!title || !content) {
                    showMessage("Por favor, llena ambos campos.");
                    return;
                }
                try {
                    const devocionalesCol = collection(db, `artifacts/${appId}/public/data/devocionales`);
                    await addDoc(devocionalesCol, {
                        title: title,
                        content: content,
                        createdAt: new Date().toISOString(),
                        user: user.uid
                    });
                    e.target.reset();
                    showMessage("¡Devocional guardado con éxito!", 'success');
                } catch (error) {
                    console.error("Error al guardar el devocional:", error);
                    showMessage("Error al guardar el devocional.");
                }
            });
            
            // --- Fin de la lógica de administración ---

            // UI navigation and event listeners
            startButton.addEventListener('click', () => {
                homeScreen.classList.add('hidden');
                menuScreen.classList.remove('hidden');
            });

            todayButton.addEventListener('click', () => {
                const keys = Object.keys(pastDevotionalsData);
                if (keys.length > 0) {
                    // Get the most recent devotional
                    const latestKey = keys.reduce((a, b) => pastDevotionalsData[a].createdAt > pastDevotionalsData[b].createdAt ? a : b);
                    const devotional = pastDevotionalsData[latestKey];
                    showDevotional(devotional.title, devotional.content);
                } else {
                    showDevotional("No hay devocionales", "Todavía no se ha agregado ningún devocional. Por favor, ve al modo de administración.");
                }
            });

            pastDevotionalsButton.addEventListener('click', () => {
                menuScreen.classList.add('hidden');
                pastDevotionalsScreen.classList.remove('hidden');
                pastDevotionalsList.innerHTML = '';
                
                const devotionalKeys = Object.keys(pastDevotionalsData).sort((a, b) => pastDevotionalsData[b].createdAt.localeCompare(pastDevotionalsData[a].createdAt));
                
                if (devotionalKeys.length === 0) {
                    pastDevotionalsList.innerHTML = '<p class="text-gray-500 text-center">No hay devocionales pasados.</p>';
                } else {
                    devotionalKeys.forEach(key => {
                        const devotional = pastDevotionalsData[key];
                        const button = document.createElement('button');
                        button.textContent = devotional.title;
                        button.className = "w-full py-3 px-6 bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-all duration-300 mb-4";
                        button.addEventListener('click', () => {
                            showDevotional(devotional.title, devotional.content);
                        });
                        pastDevotionalsList.appendChild(button);
                    });
                }
            });

            backFromAdminButton.addEventListener('click', () => {
                adminScreen.classList.add('hidden');
                menuScreen.classList.remove('hidden');
            });

            backButton.addEventListener('click', () => {
                devotionalScreen.classList.add('hidden');
                menuScreen.classList.remove('hidden');
            });
            
            backFromAdminLoginButton.addEventListener('click', () => {
                adminLoginScreen.classList.add('hidden');
                menuScreen.classList.remove('hidden');
            });

            backFromPastButton.addEventListener('click', () => {
                pastDevotionalsScreen.classList.add('hidden');
                menuScreen.classList.remove('hidden');
            });

            // Helper function to show devotional content
            function showDevotional(title, content) {
                devotionalTitleEl.textContent = title;
                devotionalContentEl.textContent = content;
                menuScreen.classList.add('hidden');
                pastDevotionalsScreen.classList.add('hidden');
                devotionalScreen.classList.remove('hidden');
            }
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="app" class="container">
        <!-- Pantalla de inicio -->
        <div id="home-screen">
            <div class="header">
                <img src="https://i.postimg.cc/XJC7kmqY/IMG-6770.jpg" alt="Logo de la iglesia" class="w-32 h-32 rounded-full mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Devocionales Diarios</h1>
            </div>
            <button id="startButton" class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300">
                Empezar
            </button>
        </div>

        <!-- Pantalla de menú -->
        <div id="menu-screen" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">IGLESIA EBENEZER EL PASO</h2>
            <button id="todayButton" class="w-full py-3 px-6 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-all duration-300 mb-4">
                Devocional de Hoy
            </button>
            <button id="pastDevotionalsButton" class="w-full py-3 px-6 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all duration-300 mb-4">
                Devocionales Pasados
            </button>
            <button id="adminButton" class="w-full py-3 px-6 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 mb-4">
                Modo de Administración
            </button>
        </div>

        <!-- Pantalla de inicio de sesión de administrador -->
        <div id="admin-login-screen" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Acceso de Administrador</h2>
            <form id="adminLoginForm" class="flex flex-col gap-4">
                <input type="password" id="password" name="password" placeholder="Ingresa la contraseña" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500">
                <button type="submit" class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300">
                    Ingresar
                </button>
            </form>
            <button id="backFromAdminLogin" class="w-full mt-6 py-2 px-4 bg-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-400 transition-all duration-300">
                ← Volver al Menú
            </button>
        </div>

        <!-- Pantalla de administración (form para agregar devocionales) -->
        <div id="admin-screen" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Agregar Devocional</h2>
            <form id="addDevotionalForm" class="flex flex-col gap-4">
                <input type="text" id="title" name="title" placeholder="Título del Devocional" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500">
                <textarea id="content" name="content" placeholder="Contenido del Devocional" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500"></textarea>
                <button type="submit" class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300">
                    Guardar Devocional
                </button>
            </form>
            <button id="backFromAdmin" class="w-full mt-6 py-2 px-4 bg-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-400 transition-all duration-300">
                ← Volver al Menú
            </button>
        </div>

        <!-- Pantalla de devocional -->
        <div id="devotional-screen" class="hidden">
            <h3 id="devotionalTitle" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="devotionalContent" class="text-gray-600 leading-relaxed"></p>
            <button id="backButton" class="w-full mt-6 py-2 px-4 bg-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-400 transition-all duration-300">
                ← Volver
            </button>
        </div>

        <!-- Pantalla de devocionales pasados -->
        <div id="past-devotionals-screen" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Devocionales Pasados</h2>
            <div id="past-devotionals-list" class="space-y-4"></div>
            <button id="backFromPast" class="w-full mt-6 py-2 px-4 bg-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-400 transition-all duration-300">
                ← Volver al Menú
            </button>
        </div>
    </div>
    
    <!-- Mensaje de confirmación -->
    <div id="messageBox" class="hidden">
        <div class="flex items-center">
            <p id="messageText" class="text-sm mr-2"></p>
            <button id="closeMessageButton" class="text-sm font-bold">OK</button>
        </div>
    </div>
</body>
</html>

